<!DOCTYPE html>
<html lang="en">
<head>
Â  <meta charset="UTF-8" />
Â  <meta name="viewport" content="width=device-width, initial-scale=1" />
Â  <title>User Tasks</title>
Â  <script src="https://cdn.tailwindcss.com"></script>
Â  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet" />
</head>
<body class="bg-gray-100 text-gray-900">

Â  <main class="max-w-3xl mx-auto p-6">
Â  Â  <h1 class="text-3xl font-bold mb-6 text-center">ðŸŽ¯ Visit & Earn Tasks</h1>

Â  Â  <section class="mb-6 bg-white rounded shadow p-4">
Â  Â  Â  <p class="mb-2 text-gray-600">Balance: <span id="userBalance" class="font-semibold text-green-600">à§³0</span></p>
Â  Â  </section>

Â  Â  <section id="tasksContainer" class="space-y-4">
Â  Â  Â  <p>Loading tasks...</p>
Â  Â  </section>
Â  </main>

Â  <script type="module">
Â  Â  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
Â  Â  import {
Â  Â  Â  getAuth,
Â  Â  Â  onAuthStateChanged
Â  Â  } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
Â  Â  import {
Â  Â  Â  getFirestore,
Â  Â  Â  collection,
Â  Â  Â  doc,
Â  Â  Â  getDoc,
Â  Â  Â  updateDoc,
Â  Â  Â  onSnapshot
Â  Â  } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

Â  Â  const firebaseConfig = {
Â  Â  Â  apiKey: "AIzaSyCkYWvYNsg2-CR88Js6gcP2nXfvwI4TW30",
Â  Â  Â  authDomain: "bdwork-346d3.firebaseapp.com",
Â  Â  Â  projectId: "bdwork-346d3",
Â  Â  Â  storageBucket: "bdwork-346d3.appspot.com",
Â  Â  Â  messagingSenderId: "900963179093",
Â  Â  Â  appId: "1:900963179093:web:81e42d67bb31d603cc92dc"
Â  Â  };

Â  Â  const app = initializeApp(firebaseConfig);
Â  Â  const auth = getAuth(app);
Â  Â  const db = getFirestore(app);

Â  Â  let currentUserData = null;
Â  Â  let currentUserId = null;
Â  Â  const tasksContainer = document.getElementById("tasksContainer");
Â  Â  const userBalanceElem = document.getElementById("userBalance");

Â  Â  onAuthStateChanged(auth, async (user) => {
Â  Â  Â  if (!user) {
Â  Â  Â  Â  window.location.href = "login.html";
Â  Â  Â  Â  return;
Â  Â  Â  }
Â  Â  Â  currentUserId = user.uid;
Â  Â  Â  await loadUserData();
Â  Â  Â  loadTasksRealtime();
Â  Â  });

Â  Â  async function loadUserData() {
Â  Â  Â  const userDocRef = doc(db, "users", currentUserId);
Â  Â  Â  const userSnap = await getDoc(userDocRef);
Â  Â  Â  if (!userSnap.exists()) {
Â  Â  Â  Â  alert("User data not found.");
Â  Â  Â  Â  return;
Â  Â  Â  }
Â  Â  Â  currentUserData = userSnap.data();
Â  Â  Â  userBalanceElem.innerText = `à§³${(currentUserData.balance || 0).toFixed(2)}`;
Â  Â  }

Â  Â  function loadTasksRealtime() {
Â  Â  Â  const tasksCol = collection(db, "tasks");

Â  Â  Â  onSnapshot(tasksCol, (snapshot) => {
Â  Â  Â  Â  if (snapshot.empty) {
Â  Â  Â  Â  Â  tasksContainer.innerHTML = "<p>No tasks available right now.</p>";
Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }

Â  Â  Â  Â  tasksContainer.innerHTML = "";
Â  Â  Â  Â  snapshot.forEach(docSnap => {
Â  Â  Â  Â  Â  const task = { id: docSnap.id, ...docSnap.data() };
Â  Â  Â  Â  Â  const done = currentUserData.tasksCompleted?.[task.id] === true;

Â  Â  Â  Â  Â  const taskDiv = document.createElement("div");
Â  Â  Â  Â  Â  taskDiv.className = "p-4 bg-white rounded shadow flex flex-col md:flex-row md:justify-between md:items-center";

Â  Â  Â  Â  Â  taskDiv.innerHTML = `
Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  <p class="font-semibold text-lg">${task.name}</p>
Â  Â  Â  Â  Â  Â  Â  <p class="text-gray-600 mb-1">${task.description || ""}</p>
Â  Â  Â  Â  Â  Â  Â  <p class="font-semibold text-indigo-600">Reward: à§³${task.reward.toFixed(2)}</p>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  `;

Â  Â  Â  Â  Â  const btn = document.createElement("button");
Â  Â  Â  Â  Â  btn.className = done
Â  Â  Â  Â  Â  Â  ? "mt-4 md:mt-0 bg-gray-400 text-white py-2 px-4 rounded cursor-not-allowed font-semibold"
Â  Â  Â  Â  Â  Â  : "mt-4 md:mt-0 bg-green-600 text-white py-2 px-4 rounded hover:bg-green-700 font-semibold transition";
Â  Â  Â  Â  Â  btn.innerText = done ? "Completed âœ“" : "Visit & Earn";

Â  Â  Â  Â  Â  btn.disabled = done;
Â  Â  Â  Â  Â  btn.onclick = () => visitAndCompleteTask(task);

Â  Â  Â  Â  Â  taskDiv.appendChild(btn);
Â  Â  Â  Â  Â  tasksContainer.appendChild(taskDiv);
Â  Â  Â  Â  });
Â  Â  Â  });
Â  Â  }

Â  Â  function visitAndCompleteTask(task) {
Â  Â  Â  if (!task.url) return alert("No URL found for this task.");
Â  Â  Â  if (currentUserData.tasksCompleted?.[task.id]) return alert("Task already completed.");

Â  Â  Â  const visitWindow = window.open(task.url, "_blank");

Â  Â  Â  if (!visitWindow) {
Â  Â  Â  Â  return alert("Please allow popups to complete this task.");
Â  Â  Â  }

Â  Â  Â  setTimeout(async () => {
Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  const newBalance = (currentUserData.balance || 0) + task.reward;
Â  Â  Â  Â  Â  const updatedTasksCompleted = { ...(currentUserData.tasksCompleted || {}) };
Â  Â  Â  Â  Â  updatedTasksCompleted[task.id] = true;

Â  Â  Â  Â  Â  await updateDoc(doc(db, "users", currentUserId), {
Â  Â  Â  Â  Â  Â  balance: newBalance,
Â  Â  Â  Â  Â  Â  tasksCompleted: updatedTasksCompleted
Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  currentUserData.balance = newBalance;
Â  Â  Â  Â  Â  currentUserData.tasksCompleted = updatedTasksCompleted;
Â  Â  Â  Â  Â  userBalanceElem.innerText = `à§³${newBalance.toFixed(2)}`;
Â  Â  Â  Â  Â  alert(`âœ… You earned à§³${task.reward.toFixed(2)} by visiting!`);
Â  Â  Â  Â  } catch (err) {
Â  Â  Â  Â  Â  alert("Error: " + err.message);
Â  Â  Â  Â  }
Â  Â  Â  }, 7000); // Wait 7 seconds
Â  Â  }
Â  </script>
</body>
</html>
