<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Jobs</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-blue-50 min-h-screen p-6">
  <div class="max-w-2xl mx-auto bg-white rounded-xl shadow-md p-6 space-y-6">
    <h1 class="text-2xl font-bold text-center text-gray-800">üì∏ Upload Screenshots to Earn Money</h1>

    <div id="jobsContainer" class="space-y-6"></div>

    <div class="text-center">
      <button onclick="logout()" class="mt-4 bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700">
        Logout
      </button>
    </div>
  </div>

  <script type="module">
    const firebaseConfig = {
      apiKey: "AIzaSyCkYWvYNsg2-CR88Js6gcP2nXfvwI4TW30",
      authDomain: "bdwork-346d3.firebaseapp.com",
      projectId: "bdwork-346d3",
      storageBucket: "bdwork-346d3.appspot.com",
      messagingSenderId: "900963179093",
      appId: "1:900963179093:web:81e42d67bb31d603cc92dc",
      measurementId: "G-FM1YJ8E5GK"
    };

    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import { 
      getFirestore, doc, getDoc, updateDoc, collection, addDoc, Timestamp 
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-storage.js";

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);

    const jobCount = 4;

    let currentUser = null;

    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        window.location.href = "login.html";
        return;
      }
      currentUser = user;
      renderJobs();
    });

    function renderJobs() {
      const container = document.getElementById("jobsContainer");
      for (let i = 1; i <= jobCount; i++) {
        container.innerHTML += `
          <div class="p-4 bg-gray-100 rounded shadow">
            <h2 class="text-lg font-semibold mb-2">Job ${i}</h2>
            <input type="file" id="screenshot${i}" accept="image/*" class="mb-2 block"/>
            <button onclick="submitJob(${i})" class="bg-green-600 text-white px-4 py-1 rounded hover:bg-green-700">Submit</button>
            <p id="status${i}" class="text-sm text-gray-600 mt-1"></p>
          </div>
        `;
      }
    }

    window.submitJob = async function(jobId) {
      const fileInput = document.getElementById(`screenshot${jobId}`);
      const statusText = document.getElementById(`status${jobId}`);
      const file = fileInput.files[0];

      if (!file) {
        statusText.innerText = "Please upload a screenshot.";
        return;
      }

      try {
        const storageRef = ref(storage, `jobScreenshots/${currentUser.uid}/job${jobId}_${Date.now()}.jpg`);
        await uploadBytes(storageRef, file);
        const downloadURL = await getDownloadURL(storageRef);

        const userDocRef = doc(db, "users", currentUser.uid);
        const userDoc = await getDoc(userDocRef);
        const currentBalance = userDoc.data().balance || 0;

        // Add job record
        await addDoc(collection(db, "jobs"), {
          uid: currentUser.uid,
          jobId: jobId,
          imageUrl: downloadURL,
          timestamp: Timestamp.now()
        });

        // Update balance
        await updateDoc(userDocRef, {
          balance: currentBalance + 5
        });

        console.log(`Job ${jobId} submitted. +5‡ß≥ added. New Balance: ‡ß≥${currentBalance + 5}`);
        statusText.innerText = `‚úÖ Job ${jobId} submitted! ‡ß≥5 added to your balance.`;
        fileInput.value = ""; // clear input
      } catch (err) {
        console.error("Error during job submit:", err);
        statusText.innerText = "‚ùå Error: " + err.message;
      }
    };

    window.logout = async function () {
      await signOut(auth);
      window.location.href = "login.html";
    };
  </script>
</body>
</html>
