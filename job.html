<!DOCTYPE html>
<html lang="en">
<head>
Â  <meta charset="UTF-8" />
Â  <meta name="viewport" content="width=device-width, initial-scale=1" />
Â  <title>User Tasks</title>
Â  <script src="https://cdn.tailwindcss.com"></script>
Â  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet" />
Â  <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.12/dist/sweetalert2.min.css" rel="stylesheet" />
</head>
<body class="bg-gray-100 text-gray-900 min-h-screen flex flex-col">

Â  <main class="max-w-4xl mx-auto p-6 flex-grow">
Â  Â  <!-- Back to Dashboard Button -->
Â  Â  <div class="mb-4">
Â  Â  Â  <a href="dashboard.html" class="inline-flex items-center text-indigo-600 hover:text-indigo-800 transition text-sm font-medium">
Â  Â  Â  Â  <i class="fas fa-arrow-left mr-2"></i>Back to Dashboard
Â  Â  Â  </a>
Â  Â  </div>

Â  Â  <h1 class="text-4xl font-extrabold mb-8 text-center text-indigo-700 select-none">ğŸ“ Available Tasks</h1>

Â  Â  <section class="mb-10 p-6 bg-white rounded-xl shadow-md text-center">
Â  Â  Â  <p class="text-xl font-semibold text-gray-800">
Â  Â  Â  Â  Your Balance: <span class="text-indigo-600">à§³</span><span id="userBalance">0.00</span>
Â  Â  Â  </p>
Â  Â  </section>

Â  Â  <section>
Â  Â  Â  <div id="tasksList" class="space-y-6">
Â  Â  Â  Â  <p class="text-center text-gray-500 text-lg">Loading tasks...</p>
Â  Â  Â  </div>
Â  Â  </section>
Â  </main>

Â  <footer class="bg-white text-center py-4 text-gray-500 select-none">
Â  Â  &copy; 2025 Your Company
Â  </footer>

Â  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.12/dist/sweetalert2.all.min.js"></script>

Â  <script type="module">
Â  Â  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
Â  Â  import {
Â  Â  Â  getFirestore, collection, onSnapshot, doc, getDoc, updateDoc, addDoc, serverTimestamp
Â  Â  } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
Â  Â  import {
Â  Â  Â  getAuth, onAuthStateChanged
Â  Â  } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
Â  Â  import {
Â  Â  Â  getStorage, ref, uploadBytes, getDownloadURL
Â  Â  } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-storage.js";

Â  Â  const firebaseConfig = {
Â  Â  Â  apiKey: "AIzaSyCkYWvYNsg2-CR88Js6gcP2nXfvwI4TW30",
Â  Â  Â  authDomain: "bdwork-346d3.firebaseapp.com",
Â  Â  Â  projectId: "bdwork-346d3",
Â  Â  Â  storageBucket: "bdwork-346d3.appspot.com",
Â  Â  Â  messagingSenderId: "900963179093",
Â  Â  Â  appId: "1:900963179093:web:81e42d67bb31d603cc92dc",
Â  Â  Â  measurementId: "G-FM1YJ8E5GK"
Â  Â  };

Â  Â  const app = initializeApp(firebaseConfig);
Â  Â  const db = getFirestore(app);
Â  Â  const auth = getAuth(app);
Â  Â  const storage = getStorage(app);

Â  Â  const tasksList = document.getElementById("tasksList");
Â  Â  const userBalanceSpan = document.getElementById("userBalance");

Â  Â  let currentUser = null;
Â  Â  let userData = null;

Â  Â  const toast = Swal.mixin({
Â  Â  Â  toast: true,
Â  Â  Â  position: 'top-end',
Â  Â  Â  showConfirmButton: false,
Â  Â  Â  timer: 3000,
Â  Â  Â  timerProgressBar: true,
Â  Â  Â  didOpen: (toast) => {
Â  Â  Â  Â  toast.addEventListener('mouseenter', Swal.stopTimer)
Â  Â  Â  Â  toast.addEventListener('mouseleave', Swal.resumeTimer)
Â  Â  Â  }
Â  Â  });

Â  Â  onAuthStateChanged(auth, async (user) => {
Â  Â  Â  if (!user) {
Â  Â  Â  Â  Swal.fire({
Â  Â  Â  Â  Â  icon: 'warning',
Â  Â  Â  Â  Â  title: 'Please log in to view tasks.',
Â  Â  Â  Â  Â  showConfirmButton: false,
Â  Â  Â  Â  Â  timer: 1500,
Â  Â  Â  Â  Â  position: 'top-end'
Â  Â  Â  Â  });
Â  Â  Â  Â  setTimeout(() => {
Â  Â  Â  Â  Â  window.location.href = "login.html";
Â  Â  Â  Â  }, 1500);
Â  Â  Â  Â  return;
Â  Â  Â  }
Â  Â  Â  currentUser = user;

Â  Â  Â  const userDocRef = doc(db, "users", user.uid);
Â  Â  Â  const userSnap = await getDoc(userDocRef);
Â  Â  Â  if (userSnap.exists()) {
Â  Â  Â  Â  userData = userSnap.data();
Â  Â  Â  Â  userBalanceSpan.textContent = (userData.balance || 0).toFixed(2);
Â  Â  Â  } else {
Â  Â  Â  Â  userBalanceSpan.textContent = "0.00";
Â  Â  Â  Â  userData = { balance: 0, completedTasks: [] };
Â  Â  Â  }

Â  Â  Â  loadTasks();
Â  Â  });

Â  Â  function loadTasks() {
Â  Â  Â  const tasksCol = collection(db, "tasks");

Â  Â  Â  onSnapshot(tasksCol, (snapshot) => {
Â  Â  Â  Â  if (snapshot.empty) {
Â  Â  Â  Â  Â  tasksList.innerHTML = "<p class='text-center text-gray-500 text-lg'>No tasks available right now.</p>";
Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }

Â  Â  Â  Â  tasksList.innerHTML = "";
Â  Â  Â  Â  snapshot.forEach(docSnap => {
Â  Â  Â  Â  Â  const task = { id: docSnap.id, ...docSnap.data() };

Â  Â  Â  Â  Â  const completed = userData.completedTasks?.includes(task.id);

Â  Â  Â  Â  Â  const taskDiv = document.createElement("div");
Â  Â  Â  Â  Â  taskDiv.className = "p-6 bg-white rounded-xl shadow hover:shadow-lg transition-shadow duration-300";

Â  Â  Â  Â  Â  let taskHtml = `
Â  Â  Â  Â  Â  Â  <p class="font-semibold text-2xl text-indigo-700 mb-2">${task.name}</p>
Â  Â  Â  Â  Â  Â  <p class="text-gray-700 mb-3">${task.description || ""}</p>
Â  Â  Â  Â  Â  Â  <p class="font-semibold text-indigo-600 mb-4">Reward: à§³${typeof task.reward === 'number' ? task.reward.toFixed(2) : '0.00'}</p>
Â  Â  Â  Â  Â  `;

Â  Â  Â  Â  Â  if (task.view) {
Â  Â  Â  Â  Â  Â  taskHtml += `<p><a href="${task.view}" target="_blank" class="inline-block mt-2 px-4 py-2 bg-indigo-100 text-indigo-700 rounded hover:bg-indigo-200 transition">View Task Details <i class="fa-solid fa-arrow-up-right-from-square ml-1"></i></a></p>`;
Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  if (completed) {
Â  Â  Â  Â  Â  Â  taskHtml += `<p class="mt-3 px-4 py-2 bg-yellow-500 text-white rounded select-none text-center font-semibold">â³ Pending Admin Approval</p>`;
Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  taskHtml += `
Â  Â  Â  Â  Â  Â  Â  <form class="mt-4 space-y-3" data-task-id="${task.id}">
Â  Â  Â  Â  Â  Â  Â  Â  <label class="block">
Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="text-gray-700">Upload Screenshot 1:</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="file" accept="image/*" name="screenshot1" class="mt-1 block w-full border border-gray-300 rounded-md p-2 file:border-0 file:bg-indigo-100 file:text-indigo-700 file:rounded file:font-semibold" required />
Â  Â  Â  Â  Â  Â  Â  Â  </label>
Â  Â  Â  Â  Â  Â  Â  Â  <label class="block">
Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="text-gray-700">Upload Screenshot 2:</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="file" accept="image/*" name="screenshot2" class="mt-1 block w-full border border-gray-300 rounded-md p-2 file:border-0 file:bg-indigo-100 file:text-indigo-700 file:rounded file:font-semibold" required />
Â  Â  Â  Â  Â  Â  Â  Â  </label>
Â  Â  Â  Â  Â  Â  Â  Â  <button type="submit" class="mt-3 px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700 transition w-full">Submit</button>
Â  Â  Â  Â  Â  Â  Â  </form>
Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  taskDiv.innerHTML = taskHtml;
Â  Â  Â  Â  Â  tasksList.appendChild(taskDiv);

Â  Â  Â  Â  Â  if (!completed) {
Â  Â  Â  Â  Â  Â  const form = taskDiv.querySelector("form");
Â  Â  Â  Â  Â  Â  form.addEventListener("submit", async (e) => {
Â  Â  Â  Â  Â  Â  Â  e.preventDefault();
Â  Â  Â  Â  Â  Â  Â  const input1 = form.querySelector('input[name="screenshot1"]');
Â  Â  Â  Â  Â  Â  Â  const input2 = form.querySelector('input[name="screenshot2"]');

Â  Â  Â  Â  Â  Â  Â  if (!(input1.files.length && input2.files.length)) {
Â  Â  Â  Â  Â  Â  Â  Â  Swal.fire({
Â  Â  Â  Â  Â  Â  Â  Â  Â  icon: 'warning',
Â  Â  Â  Â  Â  Â  Â  Â  Â  title: 'Please upload both screenshots before submitting.',
Â  Â  Â  Â  Â  Â  Â  Â  Â  position: 'top-end',
Â  Â  Â  Â  Â  Â  Â  Â  Â  toast: true,
Â  Â  Â  Â  Â  Â  Â  Â  Â  showConfirmButton: false,
Â  Â  Â  Â  Â  Â  Â  Â  Â  timer: 3000
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  await submitTask(task, input1.files[0], input2.files[0]);
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });
Â  Â  Â  });
Â  Â  }

Â  Â  async function submitTask(task, file1, file2) {
Â  Â  Â  if (!currentUser) {
Â  Â  Â  Â  toast.fire({ icon: 'error', title: "User not logged in" });
Â  Â  Â  Â  return;
Â  Â  Â  }

Â  Â  Â  try {
Â  Â  Â  Â  const userRef = doc(db, "users", currentUser.uid);
Â  Â  Â  Â  const userSnap = await getDoc(userRef);
Â  Â  Â  Â  if (!userSnap.exists()) {
Â  Â  Â  Â  Â  toast.fire({ icon: 'error', title: "User not found" });
Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }

Â  Â  Â  Â  const timestamp = Date.now();
Â  Â  Â  Â  const folderPath = `taskSubmissions/${currentUser.uid}/${task.id}_${timestamp}`;

Â  Â  Â  Â  const file1Ref = ref(storage, `${folderPath}/screenshot1_${timestamp}`);
Â  Â  Â  Â  const file2Ref = ref(storage, `${folderPath}/screenshot2_${timestamp}`);

Â  Â  Â  Â  const [snap1, snap2] = await Promise.all([
Â  Â  Â  Â  Â  uploadBytes(file1Ref, file1),
Â  Â  Â  Â  Â  uploadBytes(file2Ref, file2)
Â  Â  Â  Â  ]);

Â  Â  Â  Â  const url1 = await getDownloadURL(snap1.ref);
Â  Â  Â  Â  const url2 = await getDownloadURL(snap2.ref);

Â  Â  Â  Â  await addDoc(collection(db, "taskSubmissions"), {
Â  Â  Â  Â  Â  userId: currentUser.uid,
Â  Â  Â  Â  Â  taskId: task.id,
Â  Â  Â  Â  Â  taskName: task.name,
Â  Â  Â  Â  Â  reward: task.reward || 0,
Â  Â  Â  Â  Â  status: "pending",
Â  Â  Â  Â  Â  screenshots: [url1, url2],
Â  Â  Â  Â  Â  submittedAt: serverTimestamp(),
Â  Â  Â  Â  Â  decidedAt: null
Â  Â  Â  Â  });

Â  Â  Â  Â  const completedTasks = userSnap.data().completedTasks || [];
Â  Â  Â  Â  if (!completedTasks.includes(task.id)) {
Â  Â  Â  Â  Â  completedTasks.push(task.id);
Â  Â  Â  Â  Â  await updateDoc(userRef, { completedTasks });
Â  Â  Â  Â  Â  userData.completedTasks = completedTasks;
Â  Â  Â  Â  }

Â  Â  Â  Â  toast.fire({ icon: 'success', title: 'Task submitted successfully, pending admin approval!' });
Â  Â  Â  } catch (err) {
Â  Â  Â  Â  console.error("Submission error:", err);
Â  Â  Â  Â  toast.fire({ icon: 'error', title: 'Submission failed. Try again later.' });
Â  Â  Â  }
Â  Â  }
Â  </script>
</body>
</html>
