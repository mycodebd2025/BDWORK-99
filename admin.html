<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin Panel</title>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen p-6">

  <h1 class="text-3xl font-bold mb-6 text-center">Admin Panel</h1>

  <!-- Users Section -->
  <section class="mb-10">
    <h2 class="text-xl font-semibold mb-3">Users</h2>
    <table class="min-w-full border-collapse border border-gray-300 bg-white">
      <thead>
        <tr class="bg-gray-200">
          <th class="border border-gray-300 p-2 text-left">Email</th>
          <th class="border border-gray-300 p-2 text-left">Balance (৳)</th>
          <th class="border border-gray-300 p-2 text-left">Role</th>
          <th class="border border-gray-300 p-2 text-left">Created At</th>
        </tr>
      </thead>
      <tbody id="usersTableBody">
        <tr><td colspan="4" class="p-4 text-center">Loading users...</td></tr>
      </tbody>
    </table>
  </section>

  <!-- Withdraw Requests Section -->
  <section class="mb-10">
    <h2 class="text-xl font-semibold mb-3">Withdraw Requests</h2>
    <table class="min-w-full border-collapse border border-gray-300 bg-white">
      <thead>
        <tr class="bg-gray-200">
          <th class="border border-gray-300 p-2 text-left">User Email</th>
          <th class="border border-gray-300 p-2 text-left">Amount (৳)</th>
          <th class="border border-gray-300 p-2 text-left">Status</th>
          <th class="border border-gray-300 p-2 text-left">Actions</th>
        </tr>
      </thead>
      <tbody id="withdrawRequestsBody">
        <tr><td colspan="4" class="p-4 text-center">Loading requests...</td></tr>
      </tbody>
    </table>
  </section>

  <!-- Withdraw History Section -->
  <section class="mb-10">
    <h2 class="text-xl font-semibold mb-3">Withdraw History</h2>
    <table class="min-w-full border-collapse border border-gray-300 bg-white">
      <thead>
        <tr class="bg-gray-200">
          <th class="border border-gray-300 p-2 text-left">User Email</th>
          <th class="border border-gray-300 p-2 text-left">Amount (৳)</th>
          <th class="border border-gray-300 p-2 text-left">Status</th>
          <th class="border border-gray-300 p-2 text-left">Requested At</th>
        </tr>
      </thead>
      <tbody id="withdrawHistoryBody">
        <tr><td colspan="4" class="p-4 text-center">Loading history...</td></tr>
      </tbody>
    </table>
  </section>

  <!-- Tasks Section -->
  <section class="mb-10">
    <h2 class="text-xl font-semibold mb-3">Tasks</h2>
    <table class="min-w-full border-collapse border border-gray-300 bg-white">
      <thead>
        <tr class="bg-gray-200">
          <th class="border border-gray-300 p-2 text-left">Task ID</th>
          <th class="border border-gray-300 p-2 text-left">Description</th>
          <th class="border border-gray-300 p-2 text-left">Reward (৳)</th>
          <th class="border border-gray-300 p-2 text-left">Actions</th>
        </tr>
      </thead>
      <tbody id="tasksTableBody">
        <tr><td colspan="4" class="p-4 text-center">Loading tasks...</td></tr>
      </tbody>
    </table>
    <button id="addTaskBtn" class="mt-4 px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Add New Task</button>
  </section>

  <!-- Add Task Modal -->
  <div id="taskModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
    <div class="bg-white rounded-lg p-6 w-96">
      <h3 class="text-lg font-semibold mb-4">Add New Task</h3>
      <form id="taskForm" class="space-y-4">
        <div>
          <label for="taskId" class="block mb-1 font-medium">Task ID</label>
          <input type="text" id="taskId" class="w-full border border-gray-300 rounded px-3 py-2" required />
        </div>
        <div>
          <label for="taskDesc" class="block mb-1 font-medium">Description</label>
          <input type="text" id="taskDesc" class="w-full border border-gray-300 rounded px-3 py-2" required />
        </div>
        <div>
          <label for="taskReward" class="block mb-1 font-medium">Reward (৳)</label>
          <input type="number" id="taskReward" min="0" class="w-full border border-gray-300 rounded px-3 py-2" required />
        </div>
        <div class="flex justify-end space-x-3">
          <button type="button" id="cancelTaskBtn" class="px-4 py-2 border border-gray-400 rounded hover:bg-gray-100">Cancel</button>
          <button type="submit" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">Save Task</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    // Your Firebase config here
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_PROJECT.firebaseapp.com",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_PROJECT.appspot.com",
      messagingSenderId: "YOUR_MESSAGING_ID",
      appId: "YOUR_APP_ID"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // Load Users
    async function loadUsers() {
      const tbody = document.getElementById("usersTableBody");
      tbody.innerHTML = `<tr><td colspan="4" class="p-4 text-center">Loading users...</td></tr>`;
      try {
        const snapshot = await db.collection("users").get();
        if (snapshot.empty) {
          tbody.innerHTML = `<tr><td colspan="4" class="p-4 text-center">No users found.</td></tr>`;
          return;
        }
        let html = "";
        snapshot.forEach(doc => {
          const user = doc.data();
          html += `
            <tr class="border-t hover:bg-gray-50">
              <td class="p-2 border">${user.email || "-"}</td>
              <td class="p-2 border">৳${user.balance || 0}</td>
              <td class="p-2 border">${user.role || "user"}</td>
              <td class="p-2 border">${user.createdAt ? user.createdAt.toDate().toLocaleDateString() : "-"}</td>
            </tr>`;
        });
        tbody.innerHTML = html;
      } catch (err) {
        tbody.innerHTML = `<tr><td colspan="4" class="p-4 text-center text-red-600">Error: ${err.message}</td></tr>`;
        console.error(err);
      }
    }

    // Load Withdraw Requests
    async function loadWithdrawRequests() {
      const tbody = document.getElementById("withdrawRequestsBody");
      tbody.innerHTML = `<tr><td colspan="4" class="p-4 text-center">Loading requests...</td></tr>`;
      try {
        const snapshot = await db.collection("withdrawRequests").where("status", "==", "pending").get();
        if (snapshot.empty) {
          tbody.innerHTML = `<tr><td colspan="4" class="p-4 text-center">No pending requests.</td></tr>`;
          return;
        }
        let html = "";
        snapshot.forEach(doc => {
          const req = doc.data();
          html += `
            <tr class="border-t hover:bg-gray-50">
              <td class="p-2 border">${req.email || "-"}</td>
              <td class="p-2 border">৳${req.amount || 0}</td>
              <td class="p-2 border capitalize">${req.status || "pending"}</td>
              <td class="p-2 border space-x-2">
                <button onclick="approveRequest('${doc.id}', ${req.amount}, '${req.email}')" class="px-3 py-1 bg-green-600 text-white rounded hover:bg-green-700">Approve</button>
                <button onclick="rejectRequest('${doc.id}', ${req.amount}, '${req.email}')" class="px-3 py-1 bg-red-600 text-white rounded hover:bg-red-700">Reject</button>
              </td>
            </tr>`;
        });
        tbody.innerHTML = html;
      } catch (err) {
        tbody.innerHTML = `<tr><td colspan="4" class="p-4 text-center text-red-600">Error: ${err.message}</td></tr>`;
        console.error(err);
      }
    }

    // Load Withdraw History
    async function loadWithdrawHistory() {
      const tbody = document.getElementById("withdrawHistoryBody");
      tbody.innerHTML = `<tr><td colspan="4" class="p-4 text-center">Loading history...</td></tr>`;
      try {
        const snapshot = await db.collection("withdrawRequests").orderBy("requestedAt", "desc").get();
        if (snapshot.empty) {
          tbody.innerHTML = `<tr><td colspan="4" class="p-4 text-center">No history found.</td></tr>`;
          return;
        }
        let html = "";
        snapshot.forEach(doc => {
          const req = doc.data();
          html += `
            <tr class="border-t hover:bg-gray-50">
              <td class="p-2 border">${req.email || "-"}</td>
              <td class="p-2 border">৳${req.amount || 0}</td>
              <td class="p-2 border capitalize">${req.status || "-"}</td>
              <td class="p-2 border">${req.requestedAt ? req.requestedAt.toDate().toLocaleString() : "-"}</td>
            </tr>`;
        });
        tbody.innerHTML = html;
      } catch (err) {
        tbody.innerHTML = `<tr><td colspan="4" class="p-4 text-center text-red-600">Error: ${err.message}</td></tr>`;
        console.error(err);
      }
    }

    // Load Tasks
    async function loadTasks() {
      const tbody = document.getElementById("tasksTableBody");
      tbody.innerHTML = `<tr><td colspan="4" class="p-4 text-center">Loading tasks...</td></tr>`;
      try {
        const snapshot = await db.collection("tasks").get();
        if (snapshot.empty) {
          tbody.innerHTML = `<tr><td colspan="4" class="p-4 text-center">No tasks found.</td></tr>`;
          return;
        }
        let html = "";
        snapshot.forEach(doc => {
          const task = doc.data();
          html += `
            <tr class="border-t hover:bg-gray-50">
              <td class="p-2 border">${doc.id}</td>
              <td class="p-2 border">${task.description || "-"}</td>
              <td class="p-2 border">৳${task.reward || 0}</td>
              <td class="p-2 border">
                <button onclick="deleteTask('${doc.id}')" class="px-3 py-1 bg-red-600 text-white rounded hover:bg-red-700">Delete</button>
              </td>
            </tr>`;
        });
        tbody.innerHTML = html;
      } catch (err) {
        tbody.innerHTML = `<tr><td colspan="4" class="p-4 text-center text-red-600">Error: ${err.message}</td></tr>`;
        console.error(err);
      }
    }

    // Approve Withdraw Request
    async function approveRequest(docId, amount, userEmail) {
      if (!confirm(`Approve withdrawal of ৳${amount} for ${userEmail}?`)) return;

      try {
        const userQuery = await db.collection("users").where("email", "==", userEmail).limit(1).get();
        if (userQuery.empty) {
          alert("User not found!");
          return;
        }
        const userDoc = userQuery.docs[0];
        const userData = userDoc.data();

        // Deduct balance only if user has enough balance
        if ((userData.balance || 0) < amount) {
          alert("User does not have enough balance.");
          return;
        }

        // Deduct user balance
        await db.collection("users").doc(userDoc.id).update({
          balance: (userData.balance || 0) - amount,
        });

        // Update withdraw request status
        await db.collection("withdrawRequests").doc(docId).update({
          status: "approved",
          approvedAt: firebase.firestore.FieldValue.serverTimestamp(),
        });

        alert("Withdraw request approved and balance deducted.");
        loadUsers();
        loadWithdrawRequests();
        loadWithdrawHistory();
      } catch (err) {
        alert("Error approving request: " + err.message);
        console.error(err);
      }
    }

    // Reject Withdraw Request
    async function rejectRequest(docId, amount, userEmail) {
      if (!confirm(`Reject withdrawal of ৳${amount} for ${userEmail}?`)) return;

      try {
        // Update withdraw request status
        await db.collection("withdrawRequests").doc(docId).update({
          status: "rejected",
          rejectedAt: firebase.firestore.FieldValue.serverTimestamp(),
        });

        alert("Withdraw request rejected.");
        loadWithdrawRequests();
        loadWithdrawHistory();
      } catch (err) {
        alert("Error rejecting request: " + err.message);
        console.error(err);
      }
    }

    // Delete Task
    async function deleteTask(taskId) {
      if (!confirm(`Delete task "${taskId}"?`)) return;
      try {
        await db.collection("tasks").doc(taskId).delete();
        alert("Task deleted.");
        loadTasks();
      } catch (err) {
        alert("Error deleting task: " + err.message);
        console.error(err);
      }
    }

    // Show Add Task Modal
    const taskModal = document.getElementById("taskModal");
    const addTaskBtn = document.getElementById("addTaskBtn");
    const cancelTaskBtn = document.getElementById("cancelTaskBtn");
    const taskForm = document.getElementById("taskForm");

    addTaskBtn.addEventListener("click", () => {
      taskModal.classList.remove("hidden");
      taskForm.reset();
    });

    cancelTaskBtn.addEventListener("click", () => {
      taskModal.classList.add("hidden");
    });

    // Save New Task
    taskForm.addEventListener("submit", async (e) => {
      e.preventDefault();

      const taskId = document.getElementById("taskId").value.trim();
      const desc = document.getElementById("taskDesc").value.trim();
      const reward = parseFloat(document.getElementById("taskReward").value);

      if (!taskId || !desc || isNaN(reward) || reward < 0) {
        alert("Please enter valid task details.");
        return;
      }

      try {
        // Create or overwrite task doc with taskId
        await db.collection("tasks").doc(taskId).set({
          description: desc,
          reward: reward,
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        });
        alert("Task added successfully.");
        taskModal.classList.add("hidden");
        loadTasks();
      } catch (err) {
        alert("Error adding task: " + err.message);
        console.error(err);
      }
    });

    // Initial Load
    window.onload = () => {
      loadUsers();
      loadWithdrawRequests();
      loadWithdrawHistory();
      loadTasks();
    };
  </script>
</body>
</html>
