<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Panel with Task Management</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet" />
</head>
<body class="bg-gray-100 min-h-screen flex flex-col">
  <header class="bg-blue-600 text-white p-4 flex justify-between items-center">
    <h1 class="text-xl font-bold">Admin Panel</h1>
    <button id="logoutBtn" class="bg-red-600 px-4 py-2 rounded hover:bg-red-700 flex items-center">
      <i class="fas fa-sign-out-alt mr-2"></i> Logout
    </button>
  </header>

  <main class="flex-grow p-6 max-w-7xl mx-auto w-full space-y-10">
    <!-- Users, Withdraws, etc. will stay unchanged -->

    <!-- Task Management Section -->
    <section>
      <h2 class="text-2xl font-semibold mb-6">Task Management</h2>
      <div class="bg-white shadow-md rounded p-4 mb-6">
        <h3 class="text-lg font-semibold mb-4">Add New Task</h3>
        <div class="grid md:grid-cols-4 sm:grid-cols-2 gap-4">
          <input id="taskTitle" type="text" placeholder="Task Title" class="p-2 border rounded w-full" />
          <input id="taskDescription" type="text" placeholder="Description" class="p-2 border rounded w-full" />
          <input id="taskReward" type="number" placeholder="Reward (à§³)" class="p-2 border rounded w-full" />
          <button id="addTaskBtn" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded w-full">Add Task</button>
        </div>
      </div>

      <div class="overflow-x-auto border rounded shadow bg-white">
        <table class="w-full min-w-[700px] border-collapse border border-gray-300">
          <thead class="bg-gray-200 sticky top-0 z-10">
            <tr>
              <th class="p-3 border">Title</th>
              <th class="p-3 border">Description</th>
              <th class="p-3 border">Reward</th>
              <th class="p-3 border">Active</th>
              <th class="p-3 border">Actions</th>
            </tr>
          </thead>
          <tbody id="taskTableBody">
            <tr><td colspan="5" class="p-4 text-center text-gray-500">Loading tasks...</td></tr>
          </tbody>
        </table>
      </div>
    </section>
  </main>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import {
      getAuth,
      onAuthStateChanged,
      signOut,
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import {
      getFirestore,
      collection,
      getDocs,
      addDoc,
      updateDoc,
      deleteDoc,
      doc,
      onSnapshot
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_AUTH_DOMAIN",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_STORAGE_BUCKET",
      messagingSenderId: "YOUR_SENDER_ID",
      appId: "YOUR_APP_ID"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const logoutBtn = document.getElementById("logoutBtn");
    logoutBtn.addEventListener("click", async () => {
      await signOut(auth);
      window.location.href = "login.html";
    });

    const taskTitle = document.getElementById("taskTitle");
    const taskDescription = document.getElementById("taskDescription");
    const taskReward = document.getElementById("taskReward");
    const addTaskBtn = document.getElementById("addTaskBtn");
    const taskTableBody = document.getElementById("taskTableBody");

    addTaskBtn.addEventListener("click", async () => {
      const title = taskTitle.value.trim();
      const description = taskDescription.value.trim();
      const reward = parseFloat(taskReward.value);

      if (!title || !description || isNaN(reward)) {
        alert("Please fill in all fields correctly.");
        return;
      }

      try {
        await addDoc(collection(db, "tasks"), {
          title,
          description,
          reward,
          active: true
        });
        taskTitle.value = "";
        taskDescription.value = "";
        taskReward.value = "";
      } catch (err) {
        alert("Error adding task: " + err.message);
      }
    });

    function renderTasks(tasks) {
      if (tasks.length === 0) {
        taskTableBody.innerHTML = `<tr><td colspan="5" class="p-4 text-center">No tasks available.</td></tr>`;
        return;
      }

      taskTableBody.innerHTML = tasks.map(task => `
        <tr class="border-t">
          <td class="p-3 border"><input class="titleInput w-full p-1 border" data-id="${task.id}" value="${task.title}" /></td>
          <td class="p-3 border"><input class="descInput w-full p-1 border" data-id="${task.id}" value="${task.description}" /></td>
          <td class="p-3 border"><input class="rewardInput w-full p-1 border" type="number" data-id="${task.id}" value="${task.reward}" /></td>
          <td class="p-3 border text-center">
            <input type="checkbox" class="activeToggle" data-id="${task.id}" ${task.active ? 'checked' : ''} />
          </td>
          <td class="p-3 border text-center space-x-2">
            <button class="updateTaskBtn bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded" data-id="${task.id}">Update</button>
            <button class="deleteTaskBtn bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded" data-id="${task.id}">Delete</button>
          </td>
        </tr>
      `).join("");

      document.querySelectorAll(".updateTaskBtn").forEach(btn => {
        btn.addEventListener("click", async () => {
          const id = btn.dataset.id;
          const title = document.querySelector(`.titleInput[data-id='${id}']`).value;
          const desc = document.querySelector(`.descInput[data-id='${id}']`).value;
          const reward = parseFloat(document.querySelector(`.rewardInput[data-id='${id}']`).value);
          const active = document.querySelector(`.activeToggle[data-id='${id}']`).checked;

          try {
            await updateDoc(doc(db, "tasks", id), { title, description: desc, reward, active });
            alert("Task updated.");
          } catch (err) {
            alert("Update failed: " + err.message);
          }
        });
      });

      document.querySelectorAll(".deleteTaskBtn").forEach(btn => {
        btn.addEventListener("click", async () => {
          const id = btn.dataset.id;
          if (confirm("Delete this task?")) {
            try {
              await deleteDoc(doc(db, "tasks", id));
            } catch (err) {
              alert("Delete failed: " + err.message);
            }
          }
        });
      });
    }

    function loadTasks() {
      onSnapshot(collection(db, "tasks"), snapshot => {
        const tasks = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        renderTasks(tasks);
      });
    }

    onAuthStateChanged(auth, user => {
      if (!user) return location.href = "login.html";
      loadTasks();
    });
  </script>
</body>
</html>
