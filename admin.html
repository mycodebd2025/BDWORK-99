<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin Panel</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet" />
</head>
<body class="bg-gray-100 min-h-screen flex flex-col">

  <header class="bg-blue-600 text-white p-4 flex justify-between items-center">
    <h1 class="text-xl font-bold">Admin Panel</h1>
    <button id="logoutBtn" class="bg-red-500 hover:bg-red-600 px-3 py-1 rounded flex items-center gap-2">
      <i class="fas fa-sign-out-alt"></i> Logout
    </button>
  </header>

  <main class="flex-grow container mx-auto p-6">
    <h2 class="text-2xl font-semibold mb-4">Welcome, <span id="adminName">Admin</span></h2>

    <section class="bg-white p-4 rounded shadow">
      <h3 class="text-xl font-semibold mb-3">Withdraw Requests</h3>
      <div id="withdrawList" class="space-y-3">
        <!-- Withdraw requests will be listed here -->
      </div>
    </section>
  </main>

  <footer class="bg-blue-600 text-white text-center p-3">
    &copy; 2025 Your Company
  </footer>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import { getFirestore, collection, getDocs, doc, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCkYWvYNsg2-CR88Js6gcP2nXfvwI4TW30",
      authDomain: "bdwork-346d3.firebaseapp.com",
      projectId: "bdwork-346d3",
      storageBucket: "bdwork-346d3.appspot.com",
      messagingSenderId: "900963179093",
      appId: "1:900963179093:web:81e42d67bb31d603cc92dc",
      measurementId: "G-FM1YJ8E5GK"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const adminNameElem = document.getElementById("adminName");
    const withdrawListElem = document.getElementById("withdrawList");
    const logoutBtn = document.getElementById("logoutBtn");

    logoutBtn.addEventListener("click", async () => {
      await signOut(auth);
      window.location.href = "index.html"; // Login page
    });

    // Check user login and role
    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        alert("You must login first.");
        window.location.href = "index.html"; // Login page
        return;
      }

      // Get user data to verify role
      const userDocRef = doc(db, "users", user.uid);
      const userSnap = await getDocs(collection(db, "users")); // Not needed, replaced below

      const userDoc = await import("https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js")
        .then(({ getDoc }) => getDoc(userDocRef));

      if (!userDoc.exists()) {
        alert("User data not found.");
        await signOut(auth);
        window.location.href = "index.html";
        return;
      }

      const userData = userDoc.data();
      if (userData.role !== "admin") {
        alert("Access denied. Admins only.");
        await signOut(auth);
        window.location.href = "index.html";
        return;
      }

      // Show admin name
      adminNameElem.textContent = userData.name || "Admin";

      // Load withdraw requests
      loadWithdrawRequests();
    });

    async function loadWithdrawRequests() {
      withdrawListElem.innerHTML = "<p>Loading withdraw requests...</p>";
      try {
        const withdrawsCol = collection(db, "withdraws");
        const withdrawsSnapshot = await getDocs(withdrawsCol);
        if (withdrawsSnapshot.empty) {
          withdrawListElem.innerHTML = "<p>No withdraw requests found.</p>";
          return;
        }

        withdrawListElem.innerHTML = "";
        withdrawsSnapshot.forEach((docSnap) => {
          const data = docSnap.data();
          const id = docSnap.id;

          const statusColor = data.status === "approved" ? "green" : data.status === "rejected" ? "red" : "gray";

          const item = document.createElement("div");
          item.className = `border p-3 rounded flex justify-between items-center bg-${statusColor}-100`;

          item.innerHTML = `
            <div>
              <p><strong>User:</strong> ${data.userEmail || "Unknown"}</p>
              <p><strong>Amount:</strong> $${data.amount}</p>
              <p><strong>Status:</strong> <span class="capitalize text-${statusColor}-700">${data.status || "pending"}</span></p>
            </div>
            <div class="flex gap-2">
              ${data.status === "pending" ? `
                <button class="bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded" onclick="approveWithdraw('${id}')">Approve</button>
                <button class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded" onclick="rejectWithdraw('${id}')">Reject</button>
              ` : ""}
            </div>
          `;

          withdrawListElem.appendChild(item);
        });
      } catch (error) {
        withdrawListElem.innerHTML = `<p class="text-red-600">Error loading requests: ${error.message}</p>`;
      }
    }

    window.approveWithdraw = async function(withdrawId) {
      try {
        const withdrawDocRef = doc(db, "withdraws", withdrawId);
        await updateDoc(withdrawDocRef, { status: "approved" });
        alert("Withdraw request approved.");
        loadWithdrawRequests();
      } catch (error) {
        alert("Failed to approve: " + error.message);
      }
    }

    window.rejectWithdraw = async function(withdrawId) {
      try {
        const withdrawDocRef = doc(db, "withdraws", withdrawId);
        await updateDoc(withdrawDocRef, { status: "rejected" });
        alert("Withdraw request rejected.");
        loadWithdrawRequests();
      } catch (error) {
        alert("Failed to reject: " + error.message);
      }
    }
  </script>
</body>
</html>
