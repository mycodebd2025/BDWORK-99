
<!DOCTYPE html>
<html lang="en" >
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin Task Management</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.12/dist/sweetalert2.min.css" rel="stylesheet" />
</head>
<body class="bg-gray-100 text-gray-900 min-h-screen flex flex-col">

  <header class="bg-indigo-700 text-white p-6 flex items-center justify-between select-none">
    <h1 class="text-3xl font-extrabold flex items-center gap-3">
      <i class="fa-solid fa-tasks"></i> Admin Task Management
    </h1>
    <a href="admin.html" class="bg-indigo-500 hover:bg-indigo-600 px-4 py-2 rounded font-semibold transition">
      Back to Admin Dashboard
    </a>
  </header>

  <main class="max-w-6xl mx-auto p-6 flex-grow">
    <h2 class="text-2xl font-bold mb-6 text-center text-indigo-800">User Task Submissions</h2>

    <div id="submissionsList" class="space-y-8">
      <p class="text-center text-gray-500">Loading submissions...</p>
    </div>
  </main>

  <footer class="bg-white text-center py-4 text-gray-500 select-none">
    &copy; 2025 Your Company
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.12/dist/sweetalert2.all.min.js"></script>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import {
      getFirestore, collection, onSnapshot, doc, getDoc, updateDoc, query, orderBy
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
    import {
      getAuth, onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCkYWvYNsg2-CR88Js6gcP2nXfvwI4TW30",
      authDomain: "bdwork-346d3.firebaseapp.com",
      projectId: "bdwork-346d3",
      storageBucket: "bdwork-346d3.appspot.com",
      messagingSenderId: "900963179093",
      appId: "1:900963179093:web:81e42d67bb31d603cc92dc",
      measurementId: "G-FM1YJ8E5GK"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    const submissionsList = document.getElementById("submissionsList");

    let currentUser = null;

    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        Swal.fire({
          icon: "warning",
          title: "Please log in as admin.",
          showConfirmButton: false,
          timer: 1500,
          position: "top-end",
        });
        setTimeout(() => {
          window.location.href = "login.html";
        }, 1500);
        return;
      }
      currentUser = user;

      // Verify user is admin
      const userDoc = await getDoc(doc(db, "users", currentUser.uid));
      if (!userDoc.exists() || userDoc.data().role !== "admin") {
        Swal.fire({
          icon: "error",
          title: "Access denied",
          text: "You are not authorized to view this page.",
          showConfirmButton: false,
          timer: 2000,
          position: "top-end",
        });
        setTimeout(() => {
          window.location.href = "dashboard.html";
        }, 2000);
        return;
      }

      loadSubmissions();
    });

    function loadSubmissions() {
      const submissionsCol = collection(db, "taskSubmissions");
      const q = query(submissionsCol, orderBy("submittedAt", "desc"));

      onSnapshot(q, (snapshot) => {
        if (snapshot.empty) {
          submissionsList.innerHTML = "<p class='text-center text-gray-500 text-lg'>No submissions yet.</p>";
          return;
        }

        submissionsList.innerHTML = "";
        snapshot.forEach(async (docSnap) => {
          const submission = { id: docSnap.id, ...docSnap.data() };

          // Get user email or fallback
          let userEmail = "(unknown)";
          try {
            const userDoc = await getDoc(doc(db, "users", submission.userId));
            if (userDoc.exists()) userEmail = userDoc.data().email || userEmail;
          } catch { /* ignore */ }

          const submittedAt = submission.submittedAt ? submission.submittedAt.toDate().toLocaleString() : "Unknown";

          const decidedAt = submission.decidedAt ? submission.decidedAt.toDate().toLocaleString() : null;

          const card = document.createElement("div");
          card.className = "bg-white rounded-xl shadow p-6";

          card.innerHTML = `
            <div class="flex justify-between items-center mb-3">
              <h3 class="text-xl font-bold text-indigo-700">Task: ${submission.taskName}</h3>
              <span class="font-semibold text-indigo-600">Reward: à§³${submission.reward.toFixed(2)}</span>
            </div>

            <p class="mb-1 text-gray-700"><strong>User Email:</strong> ${userEmail}</p>
            <p class="mb-1 text-gray-700"><strong>Status:</strong> <span class="font-semibold ${
              submission.status === "approved" ? "text-green-600" : submission.status === "rejected" ? "text-red-600" : "text-yellow-600"
            }">${submission.status.toUpperCase()}</span></p>
            <p class="mb-4 text-gray-600"><strong>Submitted:</strong> ${submittedAt}${decidedAt ? " | <strong>Decided:</strong> " + decidedAt : ""}</p>

            <div class="flex gap-4 mb-4 overflow-x-auto">
              ${submission.screenshots.map(url =>
                `<a href="${url}" target="_blank" class="block w-40 h-32 overflow-hidden rounded-lg border border-gray-300 shadow hover:shadow-lg transition">
                  <img src="${url}" alt="Screenshot" class="object-cover w-full h-full" />
                </a>`).join("")}
            </div>

            <div class="flex gap-3 justify-end">
              <button ${submission.status !== "pending" ? "disabled" : ""} data-action="approve" data-id="${submission.id}" class="btn-approve px-4 py-2 rounded bg-green-600 text-white hover:bg-green-700 disabled:bg-gray-300 disabled:cursor-not-allowed transition font-semibold flex items-center gap-2">
                <i class="fa-solid fa-check"></i> Approve
              </button>
              <button ${submission.status !== "pending" ? "disabled" : ""} data-action="reject" data-id="${submission.id}" class="btn-reject px-4 py-2 rounded bg-red-600 text-white hover:bg-red-700 disabled:bg-gray-300 disabled:cursor-not-allowed transition font-semibold flex items-center gap-2">
                <i class="fa-solid fa-xmark"></i> Reject
              </button>
            </div>
          `;

          submissionsList.appendChild(card);
        });

        // Attach event listeners to buttons after DOM update
        setTimeout(() => {
          document.querySelectorAll("button.btn-approve").forEach(button => {
            button.onclick = () => handleDecision(button.dataset.id, "approve");
          });
          document.querySelectorAll("button.btn-reject").forEach(button => {
            button.onclick = () => handleDecision(button.dataset.id, "reject");
          });
        }, 200);
      });
    }

    async function handleDecision(submissionId, decision) {
      const decisionStr = decision === "approve" ? "Approve" : "Reject";

      const { value: confirmed } = await Swal.fire({
        title: `${decisionStr} this task submission?`,
        icon: decision === "approve" ? "success" : "warning",
        showCancelButton: true,
        confirmButtonText: decisionStr,
        cancelButtonText: "Cancel",
      });

      if (!confirmed) return;

      try {
        const submissionRef = doc(db, "taskSubmissions", submissionId);
        const submissionSnap = await getDoc(submissionRef);
        if (!submissionSnap.exists()) {
          Swal.fire("Error", "Submission not found.", "error");
          return;
        }
        const submission = submissionSnap.data();

        if (submission.status !== "pending") {
          Swal.fire("Info", "This submission is already decided.", "info");
          return;
        }

        // Update submission doc status & decidedAt
        await updateDoc(submissionRef, {
          status: decision === "approve" ? "approved" : "rejected",
          decidedAt: new Date()
        });

        // If approved, add reward to user balance
        if (decision === "approve") {
          const userRef = doc(db, "users", submission.userId);
          const userSnap = await getDoc(userRef);
          if (userSnap.exists()) {
            const userData = userSnap.data();
            const currentBalance = userData.balance || 0;
            const newBalance = currentBalance + (submission.reward || 0);

            // Update balance
            await updateDoc(userRef, { balance: newBalance });
          }
        }

        Swal.fire({
          icon: "success",
          title: `${decisionStr}d successfully!`,
          timer: 1800,
          showConfirmButton: false,
          position: "top-end"
        });
      } catch (error) {
        console.error("Decision error:", error);
        Swal.fire("Error", "Failed to update submission status.", "error");
      }
    }
  </script>

</body>
</html>
